apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-annotation-exclusion-rabbitmq-transformer
patch: |-
  - op: add
    path: /metadata/annotations/sas.com~1certificate-file-format
    value: pem
  - op: add
    path: /spec/template/metadata/annotations/sas.com~1certificate-file-format
    value: pem
  - op: remove
    path: /metadata/annotations/sas.com~1certificate-file-format
  - op: remove
    path: /spec/template/metadata/annotations/sas.com~1certificate-file-format
target:
  kind: StatefulSet
  name: sas-rabbitmq-server
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-batchjob-backup-restore-base-tls-volumemount-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  annotationSelector: sas.com/component-name=sas-backup-job
  kind: Job
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-batchjob-backup-restore-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/1/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  annotationSelector: sas.com/component-name=sas-backup-job
  kind: Job
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-batchjob-base-tls-certframe-transformer
patch: |-
  kind: Job
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        initContainers:
        - name: sas-certframe
          image: sas-certframe
          envFrom:
          - configMapRef:
              name: sas-certframe-ingress-certificate-config
          env:
          - name: KUBE_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR
            value: /customer-provided-ca-certificates
          volumeMounts:
          - name: security
            mountPath: /security
          - name: customer-provided-ca-certificates
            mountPath: /customer-provided-ca-certificates
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
        volumes:
        - name: security
          emptyDir: {}
        - name: customer-provided-ca-certificates
          configMap:
            name: sas-customer-provided-ca-certificates
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: Job
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-batchjob-base-tls-volumemount-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: Job
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-batchjob-configuration-restore-base-tls-certframe-transformer
patch: "- op: add\n  path: /spec/template/spec/initContainers/-\n  value:\n    name:
  sas-certframe-for-configuration\n    image: sas-certframe\n    envFrom:\n    - configMapRef:\n
  \       name: sas-certframe-ingress-certificate-config\n    env:\n    - name: KUBE_POD_NAME\n
  \     valueFrom:\n        fieldRef:\n          fieldPath: metadata.name\n    - name:
  SAS_ADDITIONAL_CA_CERTIFICATES_DIR\n      value: /customer-provided-ca-certificates\n
  \   - name: SAS_CERTIFICATE_FILE_FORMAT\n      value: jks\n    volumeMounts:\n    -
  name: security-for-configuration\n      mountPath: /security\n    - name: customer-provided-ca-certificates\n
  \     mountPath: /customer-provided-ca-certificates\n    securityContext:\n      allowPrivilegeEscalation:
  false\n      privileged: false\n      readOnlyRootFilesystem: true      \n- op:
  add\n  path: /spec/template/spec/volumes/-\n  value:\n    name: security-for-configuration\n
  \   emptyDir: {}"
target:
  annotationSelector: sas.com/component-name=sas-restore-job
  kind: Job
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-batchjob-configuration-restore-base-tls-volumemount-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security-for-configuration
      mountPath: /security
  - op: add
    path: /spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security-for-configuration
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security-for-configuration
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  annotationSelector: sas.com/component-name=sas-restore-job
  kind: Job
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-batchjob-configuration-restore-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/1/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /spec/template/spec/initContainers/1/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  annotationSelector: sas.com/component-name=sas-restore-job
  kind: Job
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-batchjob-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /spec/template/spec/initContainers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: Job
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-casdeployment-backup-agent-base-tls-transformer
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/2/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/controllerTemplate/spec/containers/2/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/controllerTemplate/spec/containers/2/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  kind: CASDeployment
  labelSelector: sas.com/backup-role=provider
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-casdeployment-backup-agent-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/2/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  kind: CASDeployment
  labelSelector: sas.com/backup-role=provider
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-casdeployment-base-tls-certframe-transformer
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/initContainers/0
    value:
      name: sas-certframe
      image: sas-certframe
      env:
      - name: KUBE_POD_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.name
      - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR
        value: /customer-provided-ca-certificates
      envFrom:
      - configMapRef:
          name: sas-certframe-ingress-certificate-config
      volumeMounts:
      - name: security
        mountPath: /security
      - name: customer-provided-ca-certificates
        mountPath: /customer-provided-ca-certificates
      securityContext:
        allowPrivilegeEscalation: false
        privileged: false
        readOnlyRootFilesystem: true
target:
  kind: CASDeployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-casdeployment-base-tls-sssd-transformer
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/controllerTemplate/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/controllerTemplate/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  kind: CASDeployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-casdeployment-base-tls-transformer
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/controllerTemplate/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/controllerTemplate/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
  - op: add
    path: /spec/controllerTemplate/spec/volumes/-
    value:
      name: security
      emptyDir: {}
  - op: add
    path: /spec/controllerTemplate/spec/volumes/-
    value:
      name: customer-provided-ca-certificates
      configMap:
        name: sas-customer-provided-ca-certificates
  - op: add
    path: /spec/controllerTemplate/metadata
    value:
      annotations:
        sas.com/certificate-file-format: pem
target:
  kind: CASDeployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-casdeployment-config-init-initcontainer-base-tls-transformer
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/initContainers/1/env/-
    value:
      name: SSL_CERT_FILE
      value: /security/trustedcerts.pem
  - op: add
    path: /spec/controllerTemplate/spec/initContainers/1/volumeMounts/-
    value:
      name: security
      mountPath: /security
target:
  annotationSelector: sas.com/config-init-mode=initcontainer
  kind: CASDeployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-casdeployment-truststore-only-sssd-transformer
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/1/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  kind: CASDeployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-casdeployment-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /spec/controllerTemplate/spec/initContainers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  kind: CASDeployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-cronjob-backup-restore-base-tls-volumemount-transformer
patch: |-
  - op: add
    path: /spec/jobTemplate/spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/jobTemplate/spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/jobTemplate/spec/template/spec/containers/1/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  annotationSelector: sas.com/component-name=sas-backup-job
  kind: CronJob
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-cronjob-base-tls-certframe-transformer
patch: |-
  kind: CronJob
  metadata:
    name: wildcard
  spec:
    jobTemplate:
      spec:
        template:
          spec:
            initContainers:
            - name: sas-certframe
              image: sas-certframe
              env:
              - name: KUBE_POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR
                value: /customer-provided-ca-certificates
              envFrom:
              - configMapRef:
                  name: sas-certframe-ingress-certificate-config
              volumeMounts:
              - name: security
                mountPath: /security
              - name: customer-provided-ca-certificates
                mountPath: /customer-provided-ca-certificates
              securityContext:
                allowPrivilegeEscalation: false
                privileged: false
                readOnlyRootFilesystem: true
            volumes:
            - name: security
              emptyDir: {}
            - name: customer-provided-ca-certificates
              configMap:
                name: sas-customer-provided-ca-certificates
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: CronJob
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-cronjob-base-tls-volumemount-transformer
patch: |-
  - op: add
    path: /spec/jobTemplate/spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/jobTemplate/spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/jobTemplate/spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: CronJob
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-cronjob-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/jobTemplate/spec/template/spec/containers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /spec/jobTemplate/spec/template/spec/initContainers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: CronJob
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-cronjob-truststore-volumemount-transformer-backup-restore
patch: |-
  - op: add
    path: /spec/jobTemplate/spec/template/spec/containers/1/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  annotationSelector: sas.com/component-name=sas-backup-job
  kind: CronJob
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-deployment-base-tls-certframe-transformer
patch: |-
  kind: Deployment
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        initContainers:
        - name: sas-certframe
          image: sas-certframe
          env:
          - name: KUBE_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR
            value: /customer-provided-ca-certificates
          envFrom:
          - configMapRef:
              name: sas-certframe-ingress-certificate-config
          volumeMounts:
          - name: security
            mountPath: /security
          - name: customer-provided-ca-certificates
            mountPath: /customer-provided-ca-certificates
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
        volumes:
        - name: security
          emptyDir: {}
        - name: customer-provided-ca-certificates
          configMap:
            name: sas-customer-provided-ca-certificates
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: Deployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-deployment-base-tls-volumemount-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: Deployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-deployment-config-init-initcontainer-base-tls-transformer
patch: |-
  kind: Deployment
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        initContainers:
        - name: sas-config-init
          env:
          - name: SSL_CERT_FILE
            value: /security/trustedcerts.pem
          volumeMounts:
          - name: security
            mountPath: /security
target:
  annotationSelector: sas.com/config-init-mode=initcontainer
  kind: Deployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-deployment-config-init-sidecar-base-tls-transformer
patch: |-
  kind: Deployment
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        containers:
        - name: sas-config-init
          env:
          - name: SSL_CERT_FILE
            value: /security/trustedcerts.pem
          volumeMounts:
          - name: security
            mountPath: /security
target:
  annotationSelector: sas.com/config-init-mode=sidecar
  kind: Deployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-deployment-connect-config-setup-base-tls-transformer
patch: |-
  kind: Deployment
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        initContainers:
        - name: sas-connect-config-setup
          env:
          - name: SSL_CERT_FILE
            value: /security/trustedcerts.pem
          volumeMounts:
          - name: security
            mountPath: /security
target:
  kind: Deployment
  name: sas-connect-spawner
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-deployment-dbmigrator-base-tls-transformer
patch: |-
  kind: Deployment
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        initContainers:
        - name: sas-db-migrator
          env:
          - name: SSL_CERT_FILE
            value: /security/trustedcerts.pem
          volumeMounts:
          - name: security
            mountPath: /security
target:
  annotationSelector: sas.com/pod-uses-db-migrator=true
  kind: Deployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-deployment-sssd-base-tls-transformer
patch: |-
  kind: Deployment
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        containers:
        - name: sssd
          env:
          - name: SSL_CERT_FILE
            value: /security/trustedcerts.pem
          volumeMounts:
          - name: security
            mountPath: /security
target:
  annotationSelector: sas.com/pod-uses-sssd=true
  kind: Deployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-deployment-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /spec/template/spec/initContainers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: Deployment
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-espconfig-base-tls-certframe-transformer
patch: |-
  kind: ESPConfig
  metadata:
    name: wildcard
  spec:
    projectTemplate:
      deployment:
        spec:
          template:
            spec:
              initContainers:
              - name: sas-certframe
                image: sas-certframe
                env:
                - name: KUBE_POD_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.name
                - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR
                  value: /customer-provided-ca-certificates
                envFrom:
                - configMapRef:
                    name: sas-certframe-ingress-certificate-config
                volumeMounts:
                - name: security
                  mountPath: /security
                - name: customer-provided-ca-certificates
                  mountPath: /customer-provided-ca-certificates
                securityContext:
                  allowPrivilegeEscalation: false
                  privileged: false
                  readOnlyRootFilesystem: true
target:
  kind: ESPConfig
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-espconfig-base-tls-transformer
patch: |-
  - op: add
    path: /spec/projectTemplate/deployment/spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/projectTemplate/deployment/spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/projectTemplate/deployment/spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
  - op: add
    path: /spec/projectTemplate/deployment/spec/template/spec/volumes/-
    value:
      name: security
      emptyDir: {}
  - op: add
    path: /spec/projectTemplate/deployment/spec/template/spec/volumes/-
    value:
      name: customer-provided-ca-certificates
      configMap:
        name: sas-customer-provided-ca-certificates
target:
  kind: ESPConfig
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-espconfig-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/projectTemplate/deployment/spec/template/spec/containers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /spec/projectTemplate/deployment/spec/template/spec/initContainers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  kind: ESPConfig
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-pgcluster-base-tls-certframe-transformer
patch: "kind: Pgcluster\nmetadata:\n  name: wildcard\nspec:\n  certframe:\n    containers:\n
  \   - envFrom: []\n      volumeMounts:\n      - name: security\n        mountPath:
  /security  \n    initContainers:\n    - name: sas-certframe\n      image: sas-certframe\n
  \     env:\n      - name: KUBE_POD_NAME\n        valueFrom:\n          fieldRef:\n
  \           fieldPath: metadata.name\n      - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR\n
  \       value: /customer-provided-ca-certificates\n      envFrom:\n      - configMapRef:\n
  \         name: sas-certframe-ingress-certificate-config\n      volumeMounts:\n
  \     - name: security\n        mountPath: /security\n      - name: customer-provided-ca-certificates\n
  \       mountPath: /customer-provided-ca-certificates\n      securityContext:\n
  \       allowPrivilegeEscalation: false\n        privileged: false\n        readOnlyRootFilesystem:
  true\n    volumes:\n    - name: security\n      emptyDir: {}\n    - name: customer-provided-ca-certificates\n
  \     configMap:\n        name: sas-customer-provided-ca-certificates"
target:
  kind: Pgcluster
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-pgcluster-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/certframe/containers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /spec/certframe/initContainers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  kind: Pgcluster
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-podtemplate-base-tls-certframe-transformer
patch: |-
  kind: PodTemplate
  metadata:
    name: wildcard
  template:
    spec:
      initContainers:
      - name: sas-certframe
        image: sas-certframe
        env:
        - name: KUBE_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR
          value: /customer-provided-ca-certificates
        envFrom:
        - configMapRef:
            name: sas-certframe-ingress-certificate-config
        volumeMounts:
        - name: security
          mountPath: /security
        - name: customer-provided-ca-certificates
          mountPath: /customer-provided-ca-certificates
        securityContext:
          allowPrivilegeEscalation: false
          privileged: false
          readOnlyRootFilesystem: true
      volumes:
      - name: security
        emptyDir: {}
      - name: customer-provided-ca-certificates
        configMap:
          name: sas-customer-provided-ca-certificates
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: PodTemplate
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-podtemplate-base-tls-volumemount-transformer
patch: |-
  - op: add
    path: /template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: PodTemplate
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-podtemplate-config-init-initcontainer-base-tls-transformer
patch: |-
  kind: PodTemplate
  metadata:
    name: wildcard
  template:
    spec:
      initContainers:
      - name: sas-config-init
        env:
        - name: SSL_CERT_FILE
          value: /security/trustedcerts.pem
        volumeMounts:
        - name: security
          mountPath: /security
target:
  annotationSelector: sas.com/config-init-mode=initcontainer
  kind: PodTemplate
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-podtemplate-config-init-sidecar-base-tls-transformer
patch: |-
  kind: PodTemplate
  metadata:
    name: wildcard
  template:
    spec:
      containers:
      - name: sas-config-init
        env:
        - name: SSL_CERT_FILE
          value: /security/trustedcerts.pem
        volumeMounts:
        - name: security
          mountPath: /security
target:
  annotationSelector: sas.com/config-init-mode=sidecar
  kind: PodTemplate
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-podtemplate-truststore-only-transformer
patch: |-
  - op: add
    path: /template/spec/containers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /template/spec/initContainers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: PodTemplate
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-statefulset-base-tls-certframe-transformer
patch: |-
  kind: StatefulSet
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        initContainers:
        - name: sas-certframe
          image: sas-certframe
          env:
          - name: KUBE_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR
            value: /customer-provided-ca-certificates
          envFrom:
          - configMapRef:
              name: sas-certframe-ingress-certificate-config
          volumeMounts:
          - name: security
            mountPath: /security
          - name: customer-provided-ca-certificates
            mountPath: /customer-provided-ca-certificates
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
        volumes:
        - name: security
          emptyDir: {}
        - name: customer-provided-ca-certificates
          configMap:
            name: sas-customer-provided-ca-certificates
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: StatefulSet
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-statefulset-base-tls-volumeMount-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /security
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
      subPath: cacerts
  - op: add
    path: /spec/template/spec/containers/0/volumeMounts/-
    value:
      name: security
      mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
      subPath: private
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: StatefulSet
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-statefulset-dbmigrator-base-tls-transformer
patch: |-
  kind: StatefulSet
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        initContainers:
        - name: sas-db-migrator
          env:
          - name: SSL_CERT_FILE
            value: /security/trustedcerts.pem
          volumeMounts:
          - name: security
            mountPath: /security
target:
  annotationSelector: sas.com/pod-uses-db-migrator=true
  kind: StatefulSet
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-statefulset-sssd-base-tls-transformer
patch: |-
  kind: StatefulSet
  metadata:
    name: wildcard
  spec:
    template:
      spec:
        containers:
        - name: sssd
          env:
          - name: SSL_CERT_FILE
            value: /security/trustedcerts.pem
          volumeMounts:
          - name: security
            mountPath: /security
target:
  annotationSelector: sas.com/pod-uses-sssd=true
  kind: StatefulSet
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: sas-statefulset-truststore-only-transformer
patch: |-
  - op: add
    path: /spec/template/spec/containers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
  - op: add
    path: /spec/template/spec/initContainers/0/envFrom/-
    value:
      configMapRef:
        name: sas-certframe-truststore-config
target:
  annotationSelector: sas.com/certificate-file-format in (pem, jks)
  kind: StatefulSet